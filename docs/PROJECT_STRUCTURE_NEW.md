# é¡¹ç›®ç»“æ„è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† Dify to OpenAI API é€‚é…å™¨çš„é¡¹ç›®ç»“æ„å’Œæ–‡ä»¶ç»„ç»‡ã€‚

## ğŸ“ æ ¹ç›®å½•ç»“æ„

```text
difyToOpenAi/
â”œâ”€â”€ src/                    # æºä»£ç ç›®å½•
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶ç›®å½•
â”œâ”€â”€ logs/                   # æ—¥å¿—æ–‡ä»¶ç›®å½•
â”œâ”€â”€ config.json            # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ config.template.json   # é…ç½®æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ package.json           # Node.js ä¾èµ–é…ç½®
â”œâ”€â”€ README.md              # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ run-tests.bat          # Windows æµ‹è¯•è¿è¡Œè„šæœ¬
â”œâ”€â”€ run-tests.sh           # Linux/Mac æµ‹è¯•è¿è¡Œè„šæœ¬
â”œâ”€â”€ start.bat              # Windows å¯åŠ¨è„šæœ¬
â”œâ”€â”€ start.sh               # Linux/Mac å¯åŠ¨è„šæœ¬
â”œâ”€â”€ Dockerfile             # Docker å®¹å™¨é…ç½®
â”œâ”€â”€ docker-compose.yml     # Docker Compose é…ç½®
â””â”€â”€ å„ç§æŠ¥å‘Šæ–‡æ¡£.md        # å®ç°æŠ¥å‘Šå’Œæ–‡æ¡£
```

## ğŸ—ï¸ æºä»£ç ç»“æ„ (src/)

```text
src/
â”œâ”€â”€ index.js               # åº”ç”¨å…¥å£æ–‡ä»¶
â”œâ”€â”€ middleware/            # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ auth.js           # API è®¤è¯å’Œæ¨¡å‹æ˜ å°„
â”‚   â””â”€â”€ errorHandler.js   # é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”œâ”€â”€ routes/               # è·¯ç”±å¤„ç†
â”‚   â”œâ”€â”€ chat.js          # èŠå¤©å®Œæˆ API
â”‚   â”œâ”€â”€ completions.js   # æ–‡æœ¬å®Œæˆ API
â”‚   â”œâ”€â”€ files.js         # æ–‡ä»¶ä¸Šä¼  API
â”‚   â”œâ”€â”€ health.js        # å¥åº·æ£€æŸ¥å’Œä¼šè¯ç®¡ç† API
â”‚   â”œâ”€â”€ models.js        # æ¨¡å‹åˆ—è¡¨ API
â”‚   â””â”€â”€ stop.js          # åœæ­¢å“åº” API
â”œâ”€â”€ services/             # æ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ difyClient.js    # Dify API å®¢æˆ·ç«¯ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
â”‚   â””â”€â”€ conversationManager.js # ä¼šè¯ç®¡ç†æœåŠ¡
â””â”€â”€ utils/               # å·¥å…·å‡½æ•°
    â””â”€â”€ logger.js        # æ—¥å¿—å·¥å…·
```

## ğŸ§ª æµ‹è¯•ç»“æ„ (tests/)

```text
tests/
â”œâ”€â”€ README.md            # æµ‹è¯•è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ unit/               # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test-class-only.js          # DifyClient ç±»æµ‹è¯•
â”‚   â”œâ”€â”€ test-logic-only.js          # æ ¸å¿ƒé€»è¾‘æµ‹è¯•
â”‚   â”œâ”€â”€ test-duplicate-issue.js     # é‡å¤å“åº”é—®é¢˜æµ‹è¯•
â”‚   â”œâ”€â”€ test-system-message-fix.js  # ç³»ç»Ÿæ¶ˆæ¯å¤„ç†æµ‹è¯•
â”‚   â””â”€â”€ test-user-consistency.js    # ç”¨æˆ·å‚æ•°ä¸€è‡´æ€§æµ‹è¯•
â”œâ”€â”€ integration/        # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test-complete-features.js   # å®Œæ•´åŠŸèƒ½é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test-all-models-duplicate.js # å¤šæ¨¡å‹é‡å¤é—®é¢˜æµ‹è¯•
â”‚   â””â”€â”€ test-real-streaming.js      # çœŸå®æµå¼å“åº”æµ‹è¯•
â”œâ”€â”€ api/               # API æµ‹è¯•
â”‚   â”œâ”€â”€ test-dify-api-diagnosis.js   # Dify API è¯Šæ–­æµ‹è¯•
â”‚   â”œâ”€â”€ test-dify-upload.js         # Dify æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
â”‚   â”œâ”€â”€ test-file-upload.js         # æ–‡ä»¶ä¸Šä¼  API æµ‹è¯•
â”‚   â””â”€â”€ test-stop-api.js            # åœæ­¢ API æµ‹è¯•
â”œâ”€â”€ multimodal/        # å¤šæ¨¡æ€æµ‹è¯•
â”‚   â”œâ”€â”€ test-multimodal.js          # å¤šæ¨¡æ€åŠŸèƒ½å®Œæ•´æµ‹è¯•
â”‚   â”œâ”€â”€ test-multimodal-text.js     # çº¯æ–‡æœ¬å¤šæ¨¡æ€æ ¼å¼æµ‹è¯•
â”‚   â””â”€â”€ test-field-fix.js           # å­—æ®µä¿®å¤éªŒè¯æµ‹è¯•
â”œâ”€â”€ session/           # ä¼šè¯ç®¡ç†æµ‹è¯•
â”‚   â”œâ”€â”€ test-conversation-fix.js     # ä¼šè¯ä¿®å¤æµ‹è¯•
â”‚   â”œâ”€â”€ test-conversation-manager.js # ä¼šè¯ç®¡ç†å™¨æµ‹è¯•
â”‚   â”œâ”€â”€ test-conversation-memory.js  # ä¼šè¯è®°å¿†æµ‹è¯•
â”‚   â”œâ”€â”€ test-openai-session.js      # OpenAI é£æ ¼ä¼šè¯æµ‹è¯•
â”‚   â””â”€â”€ test-smart-session.js       # æ™ºèƒ½ä¼šè¯ç®¡ç†æµ‹è¯•
â””â”€â”€ util/              # å·¥å…·æµ‹è¯•
    â”œâ”€â”€ simple-test.js              # åŸºç¡€åŠŸèƒ½æµ‹è¯•
    â”œâ”€â”€ test-simple-chat.js         # ç®€å•èŠå¤©æµ‹è¯•
    â””â”€â”€ test-simple-conversation.js # ç®€å•ä¼šè¯æµ‹è¯•
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### å…¥å£æ–‡ä»¶ (src/index.js)
- Express åº”ç”¨é…ç½®å’Œå¯åŠ¨
- ä¸­é—´ä»¶æ³¨å†Œ
- è·¯ç”±é…ç½®
- å…¨å±€é”™è¯¯å¤„ç†

### è®¤è¯ä¸­é—´ä»¶ (src/middleware/auth.js)
- API Key éªŒè¯
- æ¨¡å‹åˆ° Dify åº”ç”¨çš„æ˜ å°„
- é…ç½®æ–‡ä»¶åŠ è½½å’Œç®¡ç†

### Dify å®¢æˆ·ç«¯ (src/services/difyClient.js)
- **æ ¸å¿ƒç»„ä»¶**ï¼šä¸ Dify API çš„æ‰€æœ‰äº¤äº’
- OpenAI æ ¼å¼è½¬æ¢
- æµå¼å“åº”å¤„ç†
- å¤šæ¨¡æ€å†…å®¹æ”¯æŒ
- æ–‡ä»¶ä¸Šä¼ å¤„ç†

### ä¼šè¯ç®¡ç†å™¨ (src/services/conversationManager.js)
- å¯¹è¯ä¸Šä¸‹æ–‡å­˜å‚¨
- ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- OpenAI é£æ ¼ä¼šè¯ ID æ˜ å°„
- è‡ªåŠ¨æ¸…ç†å’Œå†…å­˜ç®¡ç†

### è·¯ç”±å¤„ç†
- **chat.js**: èŠå¤©å®Œæˆ API (`/v1/chat/completions`)
- **completions.js**: æ–‡æœ¬å®Œæˆ API (`/v1/completions`)
- **files.js**: æ–‡ä»¶ä¸Šä¼  API (`/v1/files`)
- **models.js**: æ¨¡å‹åˆ—è¡¨ API (`/v1/models`)
- **health.js**: å¥åº·æ£€æŸ¥å’Œä¼šè¯ç®¡ç† API
- **stop.js**: åœæ­¢å“åº” API

## ğŸ“Š æµ‹è¯•åˆ†ç±»è¯´æ˜

### Unit Tests (å•å…ƒæµ‹è¯•)
æµ‹è¯•ç‹¬ç«‹çš„ç»„ä»¶å’ŒåŠŸèƒ½ï¼š
- ç±»å’Œæ–¹æ³•çš„æ­£ç¡®æ€§
- é€»è¾‘å¤„ç†çš„å‡†ç¡®æ€§
- é”™è¯¯å¤„ç†æœºåˆ¶

### Integration Tests (é›†æˆæµ‹è¯•)
æµ‹è¯•ç»„ä»¶é—´çš„åä½œï¼š
- å®Œæ•´çš„è¯·æ±‚-å“åº”æµç¨‹
- å¤šç»„ä»¶é›†æˆåŠŸèƒ½
- ç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯

### API Tests (API æµ‹è¯•)
æµ‹è¯•å¤–éƒ¨æ¥å£ï¼š
- Dify API è¿æ¥æ€§
- æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- æ¥å£å…¼å®¹æ€§

### Multimodal Tests (å¤šæ¨¡æ€æµ‹è¯•)
æµ‹è¯•å¤šåª’ä½“åŠŸèƒ½ï¼š
- å›¾åƒå¤„ç†
- base64 ç¼–ç /è§£ç 
- å¤šæ¨¡æ€å†…å®¹è½¬æ¢

### Session Tests (ä¼šè¯æµ‹è¯•)
æµ‹è¯•ä¼šè¯ç®¡ç†ï¼š
- å¯¹è¯è¿ç»­æ€§
- ä¼šè¯æŒä¹…åŒ–
- ä¼šè¯éš”ç¦»

### Util Tests (å·¥å…·æµ‹è¯•)
åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼š
- ç®€å•çš„åŠŸèƒ½éªŒè¯
- å¼€å‘è°ƒè¯•å·¥å…·
- å¿«é€Ÿæ£€æŸ¥è„šæœ¬

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¼€å‘ç¯å¢ƒè®¾ç½®
1. å…‹éš†é¡¹ç›®
2. å®‰è£…ä¾èµ–ï¼š`npm install`
3. å¤åˆ¶é…ç½®ï¼š`cp config.template.json config.json`
4. ç¼–è¾‘é…ç½®æ–‡ä»¶
5. å¯åŠ¨æœåŠ¡ï¼š`npm start`

### æµ‹è¯•ç¯å¢ƒè®¾ç½®
1. ç¡®ä¿ Dify æœåŠ¡æ­£åœ¨è¿è¡Œ
2. é…ç½®æ­£ç¡®çš„ API ç«¯ç‚¹
3. è¿è¡Œæµ‹è¯•ï¼š`npm run test:all`

### ç”Ÿäº§éƒ¨ç½²
1. ä½¿ç”¨ Dockerï¼š`docker-compose up -d`
2. æˆ–ç›´æ¥è¿è¡Œï¼š`npm start`
3. é…ç½®åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

## ğŸ“‹ ç»´æŠ¤æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½
1. åœ¨ `src/` ä¸­æ·»åŠ ç›¸åº”æ¨¡å—
2. åœ¨ `tests/` ä¸­æ·»åŠ å¯¹åº”æµ‹è¯•
3. æ›´æ–°æ–‡æ¡£
4. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

### è°ƒè¯•é—®é¢˜
1. æŸ¥çœ‹æ—¥å¿—ï¼š`logs/` ç›®å½•
2. è¿è¡Œç›¸å…³æµ‹è¯•ï¼š`npm run test:xxx`
3. æ£€æŸ¥é…ç½®ï¼š`config.json`
4. éªŒè¯ Dify è¿æ¥

### ä»£ç è´¨é‡
- éµå¾ªç°æœ‰ä»£ç é£æ ¼
- æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†
- ç¼–å†™æ¸…æ™°çš„æ³¨é‡Š
- ä¿æŒæµ‹è¯•è¦†ç›–ç‡
