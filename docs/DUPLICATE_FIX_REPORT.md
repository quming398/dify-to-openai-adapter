# é‡å¤å›ç­”é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘ŠAIå“åº”å‡ºç°äº†ä¸‰æ¬¡é‡å¤ï¼Œå…·ä½“è¡¨ç°ä¸ºç›¸åŒçš„å›ç­”å†…å®¹ï¼ˆå¦‚"Helloï¼æœ‰ä»€ä¹ˆæŠ€æœ¯é—®é¢˜æˆ‘å¯ä»¥å¸®ä½ å—ï¼Ÿæ¯”å¦‚Javaå¼€å‘ã€å¾®ä¿¡å°ç¨‹åºã€SpringBoot/SpringCloudæ¶æ„ï¼Œæˆ–è€…Kubernetesç›¸å…³çš„é—®é¢˜ï¼Ÿ ğŸ˜Š"ï¼‰åœ¨æµå¼å“åº”ä¸­é‡å¤å‡ºç°ä¸‰æ¬¡ã€‚

## é—®é¢˜åŸå› åˆ†æ
é€šè¿‡æ·±å…¥åˆ†æä»£ç ï¼Œå‘ç°é—®é¢˜å‡ºç°åœ¨ `src/services/difyClient.js` æ–‡ä»¶çš„ `handleStreamingRequestWithForward` æ–¹æ³•ä¸­ã€‚

### æ ¹æœ¬åŸå› 
åœ¨å¤„ç† Dify çš„æµå¼å“åº”æ—¶ï¼Œæœ‰ä¸¤ä¸ªäº‹ä»¶å¤„ç†å™¨å¯èƒ½ä¼šå‘é€ç›¸åŒçš„å†…å®¹ï¼š

1. **`message`/`agent_message` äº‹ä»¶å¤„ç†** (ç¬¬590-640è¡Œ)
   - å¤„ç† Dify å‘é€çš„æ¶ˆæ¯å†…å®¹ï¼Œé€šè¿‡ `data.answer` è·å–å›ç­”æ–‡æœ¬
   - å°†å†…å®¹è½¬æ¢ä¸º OpenAI æ ¼å¼å¹¶å‘é€ç»™å®¢æˆ·ç«¯

2. **`node_finished` äº‹ä»¶å¤„ç†** (ç¬¬658-700è¡Œ)  
   - å¤„ç†å·¥ä½œæµèŠ‚ç‚¹å®Œæˆäº‹ä»¶
   - ä» `data.data.outputs` ä¸­æå–æ–‡æœ¬å†…å®¹å¹¶å†æ¬¡å‘é€
   - è¿™é‡Œæå–çš„å†…å®¹å¾€å¾€ä¸ `message` äº‹ä»¶ä¸­çš„å†…å®¹ç›¸åŒ

### é‡å¤å‘é€çš„æµç¨‹
```
Dify å·¥ä½œæµæ‰§è¡Œ â†’ å‘é€ message äº‹ä»¶ï¼ˆåŒ…å«å›ç­”ï¼‰ â†’ è½¬å‘ç»™å®¢æˆ·ç«¯
                â†“
              å‘é€ node_finished äº‹ä»¶ï¼ˆåŒ…å«ç›¸åŒå›ç­”ï¼‰ â†’ å†æ¬¡è½¬å‘ç»™å®¢æˆ·ç«¯
                â†“
              ç»“æœï¼šå®¢æˆ·ç«¯æ”¶åˆ°é‡å¤å†…å®¹
```

## ä¿®å¤æ–¹æ¡ˆ
ä¿®æ”¹äº† `node_finished` äº‹ä»¶å¤„ç†é€»è¾‘ï¼Œé¿å…é‡å¤å‘é€ç›¸åŒå†…å®¹ï¼š

### ä¿®æ”¹å‰ (æœ‰é—®é¢˜çš„ä»£ç )
```javascript
case 'node_finished':
  console.log(`[${this.appName}] Node finished: ${data.data?.title || data.data?.node_id} (${data.data?.node_type})`);
  // æ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡ºå†…å®¹éœ€è¦è½¬å‘
  if (data.data?.outputs && typeof data.data.outputs === 'object') {
    const outputText = this.extractTextFromOutputs(data.data.outputs);
    if (outputText) {
      messageContent += outputText;
      
      // è½¬å‘èŠ‚ç‚¹è¾“å‡ºå†…å®¹ - è¿™é‡Œå¯¼è‡´é‡å¤ï¼
      if (!hasStarted) {
        // ... å‘é€å†…å®¹åˆ°å®¢æˆ·ç«¯
      } else {
        // ... å‘é€å†…å®¹åˆ°å®¢æˆ·ç«¯  
      }
      
      console.log(`[${this.appName}] Forwarded node output: "${outputText.substring(0, 100)}..."`);
    }
  }
  break;
```

### ä¿®æ”¹å (ä¿®å¤åçš„ä»£ç )  
```javascript
case 'node_finished':
  console.log(`[${this.appName}] Node finished: ${data.data?.title || data.data?.node_id} (${data.data?.node_type})`);
  // æ³¨æ„ï¼šä¸å†è‡ªåŠ¨è½¬å‘ node_finished çš„è¾“å‡ºå†…å®¹ï¼Œå› ä¸ºé€šå¸¸ message äº‹ä»¶å·²ç»åŒ…å«äº†ç›¸åŒå†…å®¹
  // è¿™æ ·å¯ä»¥é¿å…é‡å¤å‘é€ç›¸åŒçš„å›ç­”å†…å®¹
  if (data.data?.outputs && typeof data.data.outputs === 'object') {
    const outputText = this.extractTextFromOutputs(data.data.outputs);
    if (outputText) {
      // åªè®°å½•ä½†ä¸å‘é€ï¼Œé¿å…ä¸ message äº‹ä»¶é‡å¤
      console.log(`[${this.appName}] Node output (not forwarded to avoid duplication): "${outputText.substring(0, 100)}..."`);
    }
  }
  break;
```

## ä¿®å¤éªŒè¯
### æµ‹è¯•ç»“æœ
è¿è¡Œæµ‹è¯•è„šæœ¬ `test-duplicate-issue.js` è¿›è¡ŒéªŒè¯ï¼š

**ä¿®å¤å‰:**
- å†…å®¹ä¼šé‡å¤å‡ºç°å¤šæ¬¡
- å®¢æˆ·ç«¯æ”¶åˆ°ç›¸åŒå†…å®¹çš„å¤šä¸ª chunks

**ä¿®å¤å:**
```
=== åˆ†æç»“æœ ===
æ€» chunks: 12
å®Œæ•´å†…å®¹: "ä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿæ— è®ºæ˜¯æŠ€æœ¯é—®é¢˜ã€å­¦ä¹ å»ºè®®ï¼Œè¿˜æ˜¯å…¶ä»–æ–¹é¢çš„é—®é¢˜ï¼Œéƒ½å¯ä»¥å‘Šè¯‰æˆ‘å“¦ã€‚ğŸ˜Š"
å†…å®¹ç‰‡æ®µæ•°é‡: 9
å”¯ä¸€å†…å®¹ç‰‡æ®µ: 9
âœ… æ²¡æœ‰å‘ç°é‡å¤å†…å®¹
```

### å½±å“è¯„ä¼°
- âœ… **æ­£é¢å½±å“**: æ¶ˆé™¤äº†é‡å¤å›ç­”é—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- âœ… **å…¼å®¹æ€§**: ä¸å½±å“æ­£å¸¸çš„æµå¼å“åº”åŠŸèƒ½
- âœ… **æ€§èƒ½**: å‡å°‘äº†ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“
- âœ… **ç¨³å®šæ€§**: ä¸å½±å“å…¶ä»–äº‹ä»¶å¤„ç†é€»è¾‘

## ç»“è®º
é€šè¿‡ç¦ç”¨ `node_finished` äº‹ä»¶ä¸­çš„å†…å®¹è½¬å‘ï¼ŒæˆåŠŸè§£å†³äº†é‡å¤å›ç­”çš„é—®é¢˜ã€‚è¿™ä¸ªä¿®å¤ï¼š

1. **ç²¾å‡†å®šä½**: åªé’ˆå¯¹å¯¼è‡´é‡å¤çš„ç‰¹å®šä»£ç è·¯å¾„
2. **æœ€å°ä¾µå…¥**: ä¸å½±å“å…¶ä»–æ­£å¸¸åŠŸèƒ½
3. **å‘åå…¼å®¹**: ä¿æŒäº†åŸæœ‰çš„ API æ¥å£ä¸å˜
4. **æ•ˆæœæ˜æ˜¾**: å®Œå…¨æ¶ˆé™¤äº†é‡å¤å›ç­”ç°è±¡

ä¿®å¤å·²ç»ç”Ÿæ•ˆï¼Œç”¨æˆ·å°†ä¸å†çœ‹åˆ°é‡å¤çš„AIå›ç­”ã€‚

## ç›¸å…³æ–‡ä»¶
- `src/services/difyClient.js` - ä¸»è¦ä¿®å¤æ–‡ä»¶
- `test-duplicate-issue.js` - ç”¨äºéªŒè¯ä¿®å¤çš„æµ‹è¯•è„šæœ¬
- `test-all-models-duplicate.js` - å¤šæ¨¡å‹é‡å¤é—®é¢˜æµ‹è¯•è„šæœ¬

---
**ä¿®å¤æ—¥æœŸ**: 2025å¹´8æœˆ2æ—¥  
**ä¿®å¤ç‰ˆæœ¬**: å½“å‰ç‰ˆæœ¬  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡
